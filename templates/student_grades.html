{% extends "_layout.html" %}

{% block title %}Bảng điểm & GPA{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">Bảng điểm chi tiết & Điểm trung bình</div>
    <div class="card-body">

        <h3 style="margin-bottom: 10px;">GPA Tích lũy (Toàn khóa)</h3>
        <div style="display: flex; gap: 30px; flex-wrap: wrap; margin-bottom: 25px; padding-bottom: 25px; border-bottom: 2px solid var(--primary-color);">
             <div style="padding: 15px; background-color: #f4f4f4; border-radius: 8px;">
                <h4 style="margin: 0 0 5px 0;">GPA Tích lũy (Hệ 10)</h4>
                <strong style="font-size: 2em; color: #0275d8;">{{ "%.2f"|format(gpa_10_cumulative) }}</strong>
            </div>
            <div style="padding: 15px; background-color: #f4f4f4; border-radius: 8px;">
                <h4 style="margin: 0 0 5px 0;">GPA Tích lũy (Hệ 4)</h4>
                <strong style="font-size: 2em; color: #5cb85c;">{{ "%.2f"|format(gpa_4_cumulative) }}</strong>
            </div>
            <div style="padding: 15px; background-color: #fff5f5; border: 1px solid #f0c2c2; border-radius: 8px; min-width: 180px;">
                <h4 style="margin: 0 0 5px 0;">Xếp loại</h4>
                <strong style="font-size: 1.4em; color: #c62828;">{{ gpa_classification }}</strong>
            </div>
        </div>

        <h3 style="margin-top: 20px;">Chi tiết điểm các môn theo Học kỳ</h3>
        
        {% if not semesters_data %}
            <p>Bạn chưa có dữ liệu điểm.</p>
        {% endif %}

        {% for hoc_ky, ky_data in semesters_data | dictsort %}
            <div class="semester-group" style="margin-bottom: 30px;">
                <h4 style="padding: 10px; background-color: #f9f9f9; border: 1px solid #ddd; border-bottom: none; font-size: 1.1em; display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap;">
                    <span>HỌC KỲ {{ hoc_ky }}</span>
                    <span style="font-size: 0.9em; font-weight: 500;">
                        (GPA Kỳ - Hệ 10: <strong style="color: #0275d8;">{{ "%.2f"|format(ky_data.gpa_10) }}</strong> | 
                         GPA Kỳ - Hệ 4: <strong style="color: #5cb85c;">{{ "%.2f"|format(ky_data.gpa_4) }}</strong>)
                    </span>
                    <span style="background:#ffeaea; color:#b71c1c; padding:6px 10px; border-radius:999px; font-size:0.9em; font-weight:600;">Xếp loại: {{ ky_data.xep_loai }}</span>
                </h4>
                
                <table class="data-table" style="margin-top: 0;">
                    <thead>
                        <tr>
                            <th rowspan="2" style="vertical-align: middle;">STT</th>
                            <th rowspan="2" style="vertical-align: middle;">Mã môn học</th>
                            <th rowspan="2" style="vertical-align: middle;">Tên môn học</th>
                            <th rowspan="2" style="vertical-align: middle; text-align: center;">Số TC</th>
                            <th colspan="4" style="text-align: center;">Điểm thành phần</th>
                            <th colspan="2" style="text-align: center;">Kết quả</th>
                        </tr>
                        <tr>
                            <th style="width: 80px; text-align: center;">CC</th>
                            <th style="width: 80px; text-align: center;">TH</th>
                            <th style="width: 80px; text-align: center;">GK</th>
                            <th style="width: 80px; text-align: center;">CK</th>
                            <th style="width: 80px; text-align: center;">Điểm 10</th>
                            <th style="width: 80px; text-align: center;">Điểm Chữ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in ky_data.grades %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td>{{ row.ma_mh }}</td>
                            <td>{{ row.ten_mh }}
                                <div class="helper-text" style="font-size: 0.85em; margin-top: 4px;">Tỷ lệ: CC {{ row.ty_le.cc }}% | TH {{ row.ty_le.th }}% | GK {{ row.ty_le.gk }}% | CK {{ row.ty_le.ck }}%</div>
                            </td>
                            <td style="text-align: center;">{{ row.so_tin_chi }}</td>
                            <td style="text-align: center;">{{ row.diem_cc if row.diem_cc is not none else '-' }}</td>
                            <td style="text-align: center;">{{ row.diem_th if row.diem_th is not none else '-' }}</td>
                            <td style="text-align: center;">{{ row.diem_gk if row.diem_gk is not none else '-' }}</td>
                            <td style="text-align: center;">{{ row.diem_ck if row.diem_ck is not none else '-' }}</td>
                            <td style="text-align: center; font-weight: bold;">
                                {{ "%.2f"|format(row.diem_tk) if row.diem_tk is not none else '-' }}
                            </td>
                            <td style="text-align: center; font-weight: bold;">
                                {{ row.diem_chu if row.diem_chu else '-' }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% endfor %}
        
        {% if chart_labels %}
        <hr style="margin: 30px 0;">
        <h2>Biểu đồ điểm tổng kết (Tất cả các môn)</h2>
         <div style="max-width: 900px; margin: 20px auto 0 auto; height: 350px;">
             <canvas id="gradesChart"></canvas>
         </div>
         {% endif %}

    </div> </div>

{% if chart_labels %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const labels = {{ chart_labels | tojson | safe }};
    const data = {{ chart_data | tojson | safe }};
    const ctx = document.getElementById('gradesChart')?.getContext('2d');

    if (ctx && data.length > 0) {
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels, // Bây giờ sẽ là "HK1-MA101", "HK2-MA102"...
                datasets: [{
                    label: 'Điểm tổng kết (hệ 10)',
                    data: data,
                    backgroundColor: 'rgba(183, 28, 28, 0.7)',
                    borderColor: 'rgba(183, 28, 28, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                     x: { title: { display: true, text: 'Mã Môn học (Theo Học kỳ)' } },
                     y: { beginAtZero: true, max: 10, title: { display: true, text: 'Điểm tổng kết (Hệ 10)' } }
                },
                plugins: { legend: { display: false } }
            }
        });
    }
});
</script>
{% endif %}
{% endblock %}
